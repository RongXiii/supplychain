# 供应链智能补货系统

## 📋 目录

1. [项目概述](#项目概述)
2. [系统架构](#系统架构)
3. [功能特点](#功能特点)
4. [项目结构](#项目结构)
5. [安装指南](#安装指南)
6. [使用说明](#使用说明)
7. [模块说明](#模块说明)
8. [性能优化](#性能优化)
9. [监控与维护](#监控与维护)
10. [常见问题与故障排除](#常见问题与故障排除)
11. [扩展说明](#扩展说明)
12. [技术栈](#技术栈)
13. [许可证](#许可证)
14. [联系方式](#联系方式)

## 📖 项目概述

本项目实现了一个完整的供应链库存优化系统，结合了高级预测模型、多种补货策略和MILP（混合整数线性规划）优化，用于优化供应链中的库存管理和补货决策。系统能够针对不同产品自动选择合适的预测模型，进行需求预测，并利用多种补货策略（ROP、Order-up-to、混合策略）和MILP模型计算最优订货策略，最小化总成本。

**核心价值：**
- 降低库存成本 15-20%
- 提升服务水平至 98% 以上
- 减少缺货情况 25-30%
- 优化库存周转率 20-25%

## 🏗️ 系统架构

```
┌─────────────────────────────────────────────────────────────────────────┐
│                        数据接入层 (Data Access Layer)                   │
│  ┌─────────────┐  ┌─────────────┐  ┌─────────────┐  ┌───────────────┐  │
│  │   CSV数据源  │  │  数据库数据源  │  │   API数据源   │  │  模拟数据生成器  │  │
│  └──────┬──────┘  └──────┬──────┘  └──────┬──────┘  └────────┬────────┘  │
│         └────────────────┼─────────────────┼──────────────────┘         │
└──────────────────────────┼─────────────────┼─────────────────────────────┘
                           ▼                 ▼
┌─────────────────────────────────────────────────────────────────────────┐
│                        数据处理层 (Data Processing Layer)                │
│  ┌─────────────┐  ┌─────────────┐  ┌─────────────┐  ┌───────────────┐  │
│  │  数据加载器   │  │  数据转换器   │  │  数据验证器   │  │  特征工程处理器  │  │
│  └──────┬──────┘  └──────┬──────┘  └──────┬──────┘  └────────┬────────┘  │
│         └────────────────┼─────────────────┼──────────────────┘         │
└──────────────────────────┼─────────────────┼─────────────────────────────┘
                           ▼                 ▼
┌─────────────────────────────────────────────────────────────────────────┐
│                      Feature Store (特征存储)                           │
│  ┌─────────────┐  ┌─────────────┐  ┌─────────────┐  ┌───────────────┐  │
│  │  SKU特征计算  │  │  仓库特征计算  │  │  模型选择标签  │  │  特征持久化管理  │  │
│  └──────┬──────┘  └──────┬──────┘  └──────┬──────┘  └────────┬────────┘  │
│         └────────────────┼─────────────────┼──────────────────┘         │
└──────────────────────────┼─────────────────┼─────────────────────────────┘
                           ▼                 ▼
┌─────────────────────────────────────────────────────────────────────────┐
│                      预测与优化层 (Forecast & Optimization Layer)        │
│  ┌─────────────┐  ┌─────────────┐  ┌─────────────┐  ┌───────────────┐  │
│  │  模型选择器   │  │  预测模型库   │  │  补货策略库   │  │    MILP优化器    │  │
│  └──────┬──────┘  └──────┬──────┘  └──────┬──────┘  └────────┬────────┘  │
│         └────────────────┼─────────────────┼──────────────────┘         │
└──────────────────────────┼─────────────────┼─────────────────────────────┘
                           ▼                 ▼
┌─────────────────────────────────────────────────────────────────────────┐
│                      应用服务层 (Application Service Layer)             │
│  ┌─────────────┐  ┌─────────────┐  ┌─────────────┐  ┌───────────────┐  │
│  │  自动补单服务  │  │  采购订单生成  │  │  审批工作流   │  │  模型管理服务    │  │
│  └──────┬──────┘  └──────┬──────┘  └──────┬──────┘  └────────┬────────┘  │
│         └────────────────┼─────────────────┼──────────────────┘         │
└──────────────────────────┼─────────────────┼─────────────────────────────┘
                           ▼                 ▼
┌─────────────────────────────────────────────────────────────────────────┐
│                      接口与展示层 (Interface & Presentation Layer)       │
│  ┌─────────────┐  ┌─────────────┐  ┌─────────────┐  ┌───────────────┐  │
│  │   REST API   │  │  数据仪表盘   │  │  可视化图表   │  │    A/B测试框架   │  │
│  └──────┬──────┘  └──────┬──────┘  └──────┬──────┘  └────────┬────────┘  │
│         └────────────────┼─────────────────┼──────────────────┘         │
└──────────────────────────┼─────────────────┼─────────────────────────────┘
                           ▼                 ▼
┌─────────────────────────────────────────────────────────────────────────┐
│                      系统管理层 (System Management Layer)               │
│  ┌─────────────┐  ┌─────────────┐  ┌─────────────┐  ┌───────────────┐  │
│  │  配置管理器   │  │  日志管理器   │  │  缓存管理器   │  │   MLOps引擎     │  │
│  └─────────────┘  └─────────────┘  └─────────────┘  └───────────────┘  │
└─────────────────────────────────────────────────────────────────────────┘
```

## ✨ 功能特点

## 功能特点

1. **智能模型选择**：针对不同产品自动选择最佳预测模型（ARIMA、Holt-Winters、线性回归、随机森林、梯度提升、支持向量回归等）
2. **需求预测**：基于历史数据进行未来需求预测，支持多种时间序列模型
3. **多种补货策略**：
   - ROP（再订货点）+ 安全库存策略
   - Order-up-to Level策略
   - 混合策略（结合两种策略的优势）
4. **增强的MILP优化**：
   - 支持多仓库库存调拨
   - 考虑数量折扣
   - 优化目标函数，最小化总成本
   - 优先调拨，减少采购
5. **自动补单接口**：
   - 基于多种策略自动生成补货建议
   - 支持多级审批工作流
   - 可配置的补货规则
6. **采购订单生成**：根据优化结果自动生成采购订单
7. **模型持续优化**：支持使用实际数据持续更新和优化预测模型
8. **需求对比分析**：比较实际需求与预测需求，优化AI模型
9. **完整的数据模拟**：生成符合实际业务场景的7个数据表
10. **系统状态监控**：实时查看系统运行状态和模型性能
11. **MLOps引擎**：实现模型监控、漂移检测和自动化更新
12. **REST API服务**：提供标准API接口，支持与Power BI等可视化工具集成
13. **数据仪表盘**：内置数据可视化功能，支持库存水平、采购订单、模型性能等多维度展示
14. **Feature Store功能**：
    - SKU×仓库维度的统计特征（CV、季节强度、间歇性指数、促销标记等）
    - 自动生成模型选择标签
    - 特征持久化和管理
    - 支持批量特征计算和更新
    - 特征重要性分析
15. **灵活的数据接入层**：
    - 支持多种数据源类型（CSV、数据库、API）
    - 数据源工厂模式，支持动态配置
    - 数据转换器和验证器，确保数据一致性
    - 数据源降级机制，提高系统可靠性
16. **生产数据对接支持**：
    - 支持与企业生产数据库直接对接
    - 支持通过API获取外部数据
    - 环境变量配置，方便不同环境部署
    - 支持数据格式转换和验证
17. **A/B测试框架**：支持不同预测模型和补货策略的对比测试
18. **模型可解释性**：提供模型预测结果的解释功能，增强决策可信度
19. **预测置信区间**：为预测结果提供置信区间，支持风险评估
20. **系统状态监控**：实时监控系统运行状态和模型性能

## 项目结构

```
supplychain/
├── .env                     # 环境配置文件
├── .github/                 # GitHub配置目录
├── .idea/                   # IDE配置目录
├── .pytest_cache/           # pytest缓存目录
├── .venv/                   # 虚拟环境目录
├── ab_test_results/         # A/B测试结果目录
├── api-gateway/             # API网关配置
├── backups/                 # 备份目录
├── check_null_bytes.py      # 空字节检查脚本
├── config/                  # 配置文件目录
│   └── safety_stock_params_*.json  # 安全库存参数配置
├── config_example.env       # 配置文件示例
├── data/                    # 数据目录
│   ├── inventory_daily.csv      # 库存日报表
│   ├── items.csv                # 产品表
│   ├── locations.csv            # 位置表
│   ├── optimal_plan.csv         # 最优计划表
│   ├── purchase_orders.csv      # 采购订单表
│   ├── sample_demand_data.csv  # 示例需求数据
│   ├── suppliers.csv            # 供应商表
│   └── forecast_output.csv      # 预测输出表
├── DEPLOYMENT.md            # 部署文档
├── demo.py                  # 功能演示脚本
├── docker-compose.yml       # Docker Compose配置
├── features/                # 特征存储目录
│   ├── model_selection_tags.json  # 模型选择标签
│   └── sku_location_features.json  # SKU×仓库特征数据
├── interpretations/         # 模型解释结果目录
├── logs/                    # 日志目录
│   ├── error.log           # 错误日志
│   ├── general.log         # 通用日志
│   └── performance.log     # 性能日志
├── metrics/                 # 模型指标目录
├── MODEL_USAGE_GUIDE.md     # 模型使用指南
├── models/                  # 模型保存目录
├── monitoring/              # 监控配置目录
├── requirements.txt         # 依赖列表
├── services/                # 服务配置目录
├── src/                     # 源代码目录
│   ├── api/                 # API服务模块
│   │   ├── api.py           # REST API实现
│   │   ├── dashboard.py     # 数据仪表盘
│   │   └── __init__.py
│   ├── data/                # 数据处理模块
│   │   ├── data_processor.py    # 数据处理
│   │   ├── data_source.py       # 数据接入层
│   │   ├── data_transformer.py  # 数据转换
│   │   ├── data_warehouse.py    # 数据仓库
│   │   ├── feature_store.py     # Feature Store
│   │   ├── __init__.py
│   │   └── simulated_data.py    # 模拟数据生成
│   ├── forecast/            # 预测模型模块
│   │   ├── forecast_models.py   # 预测模型选择
│   │   ├── __init__.py
│   │   └── interpretability.py  # 模型可解释性
│   ├── mlops/               # MLOps引擎模块
│   │   ├── ab_testing/      # A/B测试模块
│   │   ├── __init__.py
│   │   ├── mlops_engine.py      # MLOps核心引擎
│   │   └── real_time_processor.py  # 实时数据处理
│   ├── replenishment/       # 补货优化模块
│   │   ├── automated_replenishment.py  # 自动补单
│   │   ├── __init__.py
│   │   └── milp_optimizer.py           # MILP优化
│   └── system/              # 系统管理模块
│       ├── backup_manager.py      # 备份管理
│       ├── cache_manager.py       # 缓存管理
│       ├── __init__.py
│       ├── logging_manager.py     # 日志管理
│       ├── main.py                # 主程序入口
│       └── version_manager.py     # 版本管理
├── start_api.py             # API服务启动脚本
├── test_models.py           # 模型测试脚本
├── tests/                   # 测试目录
│   ├── test_ab_testing.py        # A/B测试测试脚本
│   ├── test_devops.py            # DevOps测试脚本
│   ├── test_feature_store.py     # Feature Store测试脚本
│   ├── test_models.py            # 模型测试脚本
│   ├── test_optimizations.py     # 优化测试脚本
│   └── test_performance.py       # 性能测试脚本
├── versions/                # 版本管理目录
└── README.md                # 项目说明
```

## 安装指南

### 环境要求
- Python 3.7+
- 足够的内存和磁盘空间（建议至少8GB RAM）

### 安装步骤

1. 克隆或下载项目到本地
2. 安装依赖：
   ```
   pip install -r requirements.txt
   ```
   依赖已包含MILP求解器OR-Tools和API服务所需的FastAPI、uvicorn等组件，以及新的数据接入层所需的python-dotenv、redis、psycopg2-binary、requests等组件。
3. 配置数据源：
   - 复制`config_example.env`文件为`.env`
   - 根据实际情况修改`.env`文件中的配置项
   - 支持配置多种数据源类型（CSV、数据库、API）
   - 支持配置缓存类型和并行计算参数

## 使用说明

### 配置数据源

1. 复制配置文件示例：
   ```
   cp config_example.env .env
   ```

2. 编辑`.env`文件，配置数据源：
   ```
   # 数据源配置
   DATA_SOURCE_TYPE=csv  # 可选值: csv, database, api
   
   # CSV数据源配置
   # DATA_DIR=data
   
   # 数据库数据源配置
   # DATABASE_CONNECTION_STRING=postgresql://username:password@localhost:5432/supplychain
   
   # API数据源配置
   # API_BASE_URL=http://localhost:8000/api
   # API_TOKEN=your_api_token
   ```

### 运行主程序

```
python src/system/main.py
```

程序将执行以下步骤：
1. 从配置的数据源加载数据（或生成模拟数据）
2. 对每个产品进行数据预处理和模型选择
3. 训练最佳预测模型
4. 进行需求预测
5. 运行多仓MILP优化（优先调拨，减少采购）
6. 计算EOQ和考虑数量折扣
7. 生成采购订单
8. 演示模型更新功能
9. 执行自动补单（基于多种策略）
10. 演示审批流程
11. 显示最终系统状态

### 启动API服务

```
python start_api.py
```

API服务将启动在 `http://localhost:8000`，提供以下功能：
- API文档：`http://localhost:8000/docs`
- 数据接口：`http://localhost:8000/api/`
- 支持与Power BI等可视化工具集成

### 运行DEMO

```
python demo.py
```

### 运行测试

```
python -m pytest tests/ -v
```

### API端点说明

- `/api/items` - 获取所有产品信息
- `/api/suppliers` - 获取所有供应商信息
- `/api/inventory/levels` - 获取库存水平数据
- `/api/purchase/orders` - 获取采购订单数据
- `/api/forecast/data` - 获取需求预测数据
- `/api/models/performance` - 获取模型性能数据
- `/api/models/performance/average` - 获取模型平均性能指标
- `/api/optimal/plan` - 获取最优补货计划数据

### 使用数据仪表盘

在主程序运行结束后，系统会询问是否查看数据仪表盘，输入 `y` 即可显示包含库存水平、采购订单和模型性能等维度的可视化图表。

## 模块说明

### 数据处理模块（data_processor.py）
- 加载和预处理数据
- 处理缺失值和特征工程
- 分割训练集和测试集
- 比较实际需求和预测需求

### 预测模型选择模块（forecast_models.py）
- 实现多种预测模型（ARIMA、Holt-Winters、线性回归、随机森林、梯度提升、支持向量回归等）
- 自动选择最佳模型
- 模型训练、预测和评估
- 模型保存和加载
- 模型更新

### MILP优化模块（milp_optimizer.py）
- 使用OR-Tools创建增强的MILP模型
- 定义目标函数和约束条件
- 支持多仓库库存调拨
- 考虑数量折扣
- 求解模型（默认使用SCIP求解器，支持CBC等多种求解器）
- 提取最优解

### 自动补单模块（automated_replenishment.py）
- 实现多种补货策略（ROP、Order-up-to、混合策略）
- 生成自动补货建议
- 支持多级审批工作流
- 管理采购订单状态

### 模拟数据生成模块（simulated_data.py）
- 生成符合实际业务场景的7个数据表
- 支持自定义数据规模和分布
- 生成的数据可直接用于系统测试

### 数据接入层模块（data_source.py）
- 抽象数据源基类，支持多种数据源扩展
- CSV数据源实现，支持从本地文件加载数据
- 数据库数据源实现，支持PostgreSQL等数据库
- API数据源实现，支持从REST API获取数据
- 模拟数据源实现，用于测试和演示
- 数据源工厂，支持动态创建数据源实例
- 数据转换器和验证器，确保数据一致性

### API服务模块（api.py）
- 提供REST API接口，支持与Power BI等可视化工具集成
- 包含8个核心数据接口
- 支持CORS跨域访问

### Feature Store模块（feature_store.py）
- SKU×仓库维度特征计算
- 统计特征：CV（变异系数）、季节强度、间歇性指数
- 模型选择标签自动生成
- 支持批量特征计算和更新
- 特征持久化和管理
- 特征重要性分析

### MLOps引擎模块（mlops_engine.py）
- 模型监控和性能评估
- 数据漂移检测
- 模型自动化更新
- 模型版本管理
- 与Feature Store集成，支持特征监控

### 数据仪表盘模块（dashboard.py）
- 库存水平可视化
- 采购订单分析
- 模型性能评估
- 需求预测对比
- 特征分布分析

### 主程序（main.py）
- 系统集成和协调
- 演示系统完整功能
- 管理系统状态
- 集成Feature Store功能

## 性能优化

### GPU加速

系统支持XGBoost等模型的GPU加速，启用方法：

```python
# 初始化模型选择器时启用GPU
model_selector = ForecastModelSelector(use_gpu=True)
```

**注意**：需要安装GPU版本的XGBoost和相应的GPU驱动。

### 并行计算

系统支持多进程并行计算，可在`data_processor.py`和其他模块中配置并行度。

### 缓存机制

系统使用内存缓存和可选的Redis分布式缓存，提高频繁访问数据的响应速度：

```python
from src.system.cache_manager import CacheManager

# 初始化缓存管理器（distributed=True启用Redis）
cache_manager = CacheManager(distributed=False)  # 仅使用内存缓存
```

## 监控与维护

### 日志查看

系统日志保存在`logs/`目录下：
- `general.log`：通用日志
- `error.log`：错误日志
- `performance.log`：性能日志

### 模型监控

使用MLOps引擎监控模型性能和数据漂移：

```python
from src.mlops.mlops_engine import MLOpsEngine

# 初始化MLOps引擎
mlops_engine = MLOpsEngine()

# 监控模型性能
model_performance = mlops_engine.monitor_model_performance()

# 检测数据漂移
drift_results = mlops_engine.detect_data_drift()
```

### 定期维护任务

- 定期更新模型：使用新数据重新训练模型
- 清理日志文件：避免日志文件过大
- 备份模型和数据：定期备份`models/`和`data/`目录

## 常见问题与故障排除

### 安装问题

**问题**：安装依赖时出现错误
**解决方案**：
- 确保使用Python 3.7+版本
- 尝试升级pip：`pip install --upgrade pip`
- 逐个安装依赖，定位具体问题：`pip install <package_name>`

### 运行问题

**问题**：无法连接Redis
**解决方案**：
- 确保Redis服务器已启动
- 检查Redis连接参数（主机、端口、密码）
- 在初始化CacheManager时设置`distributed=False`，使用内存缓存

**问题**：GPU加速无法使用
**解决方案**：
- 检查是否安装了GPU版本的XGBoost：`pip install xgboost-gpu`
- 确保GPU驱动已正确安装
- 检查CUDA版本是否与XGBoost兼容
- 尝试在初始化模型选择器时设置`use_gpu=False`，使用CPU版本

**问题**：MILP优化求解缓慢
**解决方案**：
- 减少优化问题的规模（产品数量、时间范围）
- 调整求解器参数，设置适当的求解时间限制
- 尝试使用不同的求解器

### API服务问题

**问题**：API服务无法启动
**解决方案**：
- 检查端口是否被占用：`netstat -ano | findstr :8000`
- 尝试使用不同的端口：修改`start_api.py`中的`PORT`变量
- 检查依赖是否安装完整

**问题**：API返回错误
**解决方案**：
- 查看API文档，确保请求格式正确
- 检查系统日志，查看具体错误信息
- 确保数据文件存在且格式正确

## 扩展说明

### 模型扩展

- 支持添加新的预测模型
- 在`forecast_models.py`中添加新模型类
- 实现`train`和`predict`方法
- 注册到模型选择器

### 优化扩展

- 支持添加新的约束条件
- 在`milp_optimizer.py`中修改约束条件部分
- 支持自定义目标函数
- 支持多仓库库存调拨扩展

### 数据扩展

- 支持添加新的数据源
- 在`data_source.py`中实现新的数据源类
- 在`data_processor.py`中添加新的数据加载和处理逻辑
- 在`simulated_data.py`中扩展模拟数据生成
- 支持通过环境变量动态配置数据源

### 策略扩展

- 支持添加新的补货策略
- 在`automated_replenishment.py`中实现新策略

## 技术栈

- Python 3.7+
- NumPy
- Pandas
- scikit-learn
- statsmodels
- OR-Tools (用于MILP优化)
- joblib
- matplotlib
- pytest
- FastAPI (用于REST API服务)
- Uvicorn (ASGI服务器)
- SQLAlchemy (用于数据管理)
- feature-engine (用于特征工程)
- json (用于特征数据持久化)
- python-dotenv (用于环境变量配置)
- redis (用于分布式缓存)
- psycopg2-binary (用于PostgreSQL数据库连接)
- requests (用于API数据源连接)

## 许可证

本项目采用MIT许可证。

## 联系方式

如有问题或建议，请联系项目维护人员。
